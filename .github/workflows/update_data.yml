name: Update YouBike Data

on:
  schedule:
    # å°ç£æ™‚é–“ï¼šæ¯å°æ™‚çš„ 0 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ (ä¾‹å¦‚ 01:00, 02:00, ...)
    - cron: '0 * * * *'
  # å…è¨±åœ¨ GitHub é é¢æ‰‹å‹•é»æ“ŠæŒ‰éˆ•åŸ·è¡Œ
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    # ğŸŒŸ é—œéµï¼šæ˜ç¢ºæˆäºˆ GITHUB_TOKEN å¯«å…¥æ¬Šé™ ğŸŒŸ
    permissions:
      contents: write # ç¢ºä¿å·¥ä½œæµç¨‹å¯ä»¥å¯«å…¥å„²å­˜åº«å…§å®¹

    steps:
      - name: Check out repository
        # ä½¿ç”¨æœ€æ–°ç‰ˆçš„ checkout
        uses: actions/checkout@v4
        with:
          # ğŸŒŸ ç¢ºä¿ä½¿ç”¨æ‚¨çš„å€‹äººå­˜å–æ¬Šæ– (PAT) GH_PAT ğŸŒŸ
          # é€™æ˜¯ç¹éæ’ç¨‹ä»»å‹™æ¬Šé™é™åˆ¶çš„æœ€å¼·ä¿è­‰ã€‚
          token: ${{ secrets.GH_PAT }}
          # å–å¾—å®Œæ•´çš„ Git æ­·å²ï¼Œç¢ºä¿ Rebase/Auto-Commit æˆåŠŸ
          fetch-depth: 0

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch new data
        # å‚³å…¥ TDX å¯†é‘°çµ¦ Python è…³æœ¬ä½¿ç”¨
        env:
          TDX_CLIENT_ID: ${{ secrets.TDX_CLIENT_ID }}
          TDX_CLIENT_SECRET: ${{ secrets.TDX_CLIENT_SECRET }}
        # åŸ·è¡ŒæŠ“å–è³‡æ–™çš„è…³æœ¬
        run: python fetch_data.py --source tdx

      # ğŸŒŸ æ ¸å¿ƒè§£æ±ºæ–¹æ¡ˆï¼šè‡ªå‹• Commit, Pull/Rebase, å’Œ Push ğŸŒŸ
      - name: Commit and Push Changes Automatically
        # ä½¿ç”¨å°ˆé–€è™•ç† Git æµç¨‹çš„ Action
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æŒ‡å®šè¦è¿½è¹¤å’Œæäº¤çš„æª”æ¡ˆ
          file_pattern: 'src/stations.json'
          # è¨­å®šæäº¤è¨Šæ¯
          commit_message: 'Automated data update'
          # è¨­å®šæäº¤è€…çš„åç¨±
          commit_user_name: 'github-actions[bot]'
          # è¨­å®šæäº¤è€…çš„ Email
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          # é€™å€‹ Action æœƒè‡ªå‹•è™•ç†ï¼š
          # 1. æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰è®Šå‹•ã€‚
          # 2. å¦‚æœæœ‰è®Šå‹•ï¼ŒåŸ·è¡Œ git add å’Œ git commitã€‚
          # 3. åŸ·è¡Œ git pull --rebase (è§£æ±º 'fetch first' éŒ¯èª¤)ã€‚
          # 4. åŸ·è¡Œ git push (ä½¿ç”¨ actions/checkout æ­¥é©Ÿæä¾›çš„ PAT é€²è¡Œé©—è­‰ï¼Œè§£æ±º '403 denied' éŒ¯èª¤)ã€‚
